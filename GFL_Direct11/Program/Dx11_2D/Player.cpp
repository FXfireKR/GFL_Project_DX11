#include "stdafx.h"
#include "Player.h"

Player::Player()
{
}

Player::~Player()
{
}

HRESULT Player::init()
{
	tacDoll = new GriffonDoll;
	tacDoll->init();

	//부착물 최대 40개 보유제한
	//for (int i = 0; i < 40; ++i)
	//{
	//	EquipBase temp;
	//	mPlayerEquip.insert(make_pair(temp.getWeaponID(), temp));
	//}

	//EquipIter = mPlayerEquip.begin();

	//EquipIter->second = EQUIP->getEquipInfo("EOT 516");
	//++EquipIter;

	//EquipIter->second = EQUIP->getEquipInfo("16LAB_MARS");
	//++EquipIter;

	//EquipIter->second = EQUIP->getEquipInfo("VFL6-24X56");
	//++EquipIter;

	//EquipIter->second = EQUIP->getEquipInfo("VFL16-48X80");
	//++EquipIter;

	//EquipIter->second = EQUIP->getEquipInfo("APCR고속탄");
	//++EquipIter;

	//EquipIter->second = EQUIP->getEquipInfo("Mk169철갑탄");
	//++EquipIter;

	//EquipIter->second = EQUIP->getEquipInfo("JHP고속탄");
	//++EquipIter;

	//EquipIter->second = EQUIP->getEquipInfo("Mk169강화철갑탄");
	//++EquipIter;

	//EquipIter->second = EQUIP->getEquipInfo("AMP_COMPM4");
	//++EquipIter;

	//EquipIter->second = EQUIP->getEquipInfo("16LAB연장총열");
	//++EquipIter;

	//EquipIter->second = EQUIP->getEquipInfo("AC16소음기");

	//OwnEquipNumber = 11;



	//전체 할당
	//tacDoll->Create_IOPtacDoll(IOP_AA12);
	//tacDoll->Create_IOPtacDoll(IOP_AK12);
	//tacDoll->Create_IOPtacDoll(IOP_THUNDER);
	//tacDoll->Create_IOPtacDoll(IOP_UMP45MOD);

	//tacDoll->Create_IOPtacDoll(IOP_AR15MOD);
	//tacDoll->Create_IOPtacDoll(IOP_PKP);
	//tacDoll->Create_IOPtacDoll(IOP_M4A1MOD);

	//tacDoll->Create_IOPsptDoll(IST_BGM_71);

	//현재 정보 저장
	currentSquad = 1;
	focusTacdolID = 0;
	cFocusTacDollID = 0;
	//curntSuportDoll = IST_BGM_71;

	sPos.x = sPos.y = 0;
	ePos.x = ePos.y = 0;

	multiSelectMod = false;
	RemUnit_Toggle = false;

	return S_OK;
}

void Player::release()
{
	tacDoll->release();
	SAFE_DEL(tacDoll);
}

void Player::update()
{
	Change_FocusTacDoll();

	//멀티 선택일경우
	if (vMultiSelect.size() > 0)
	{
		mPos.x = 0.0f;
		mPos.y = 0.0f;

		for (auto& it : vMultiSelect)
		{
			mPos.x += this->getIOPdoll_crntSquad(it)->getCharacterPos().x;
			mPos.y += this->getIOPdoll_crntSquad(it)->getCharacterPos().y;
		}

		mPos.x /= vMultiSelect.size();
		mPos.y /= vMultiSelect.size();
	}

	//화력소대가 안불렸다면
	/*if (tacDoll->getSupportDoll(curntSuportDoll) != nullptr)
	{
		if (!tacDoll->getSupportDoll(curntSuportDoll)->isCalling())
		{
			for (auto& it : tacDoll->getSquad(currentSquad)->mSquad)
				it.second->update();
		}
	}
	else*/
		for (auto& it : tacDoll->getSquad(currentSquad)->mSquad)
			it.second->update();


	//if (tacDoll->getSupportDoll(curntSuportDoll) != nullptr)
	//	tacDoll->getSupportDoll(curntSuportDoll)->update();
}

void Player::render()
{
	if (multiSelectMod)
	{
		DRAWMANAGER->renderRect(sPos.x - BDATA->getVirtualPos().x, sPos.y - BDATA->getVirtualPos().y, (ePos.x - sPos.x), (ePos.y - sPos.y), ColorF(0, 255, 0));
	}

	//char str[256];
	//sprintf(str, "Middle Point : %.2f  %.2f", mPos.x, mPos.y);
	//TEXT->Create_TextField("TEST", L"굴림체", str, 20, DWRITE_FONT_WEIGHT_BOLD);
	//TEXT->TextRender("TEST", 0.0F, 150.0F, { 255.0F,0.0F,0.0F });

	//sprintf(str, "Target Point : %.2f  %.2f", trgPos.x, trgPos.y);
	//TEXT->Create_TextField("TEST", L"굴림체", str, 20, DWRITE_FONT_WEIGHT_BOLD);
	//TEXT->TextRender("TEST", 0.0F, 180.0F, { 255.0F,0.0F,0.0F });

	//if (tacDoll->getSupportDoll(curntSuportDoll) != nullptr)
	//	tacDoll->getSupportDoll(curntSuportDoll)->render();

	//for (auto& it : tacDoll->getSquad(currentSquad)->mSquad)
	//	it.second->render();
}

void Player::Change_FocusTacDoll()
{
	//5~0 번 까지 유닛 지정 선택
	if (KEYMANAGER->isKeyDown(VK_LCONTROL))
		RemUnit_Toggle = true;

	//NumberPad Action
	{
		if (KEYMANAGER->isKeyDown('1'))
			RemUnit_Toggle ? SaveRemUnit(1) : LoadRemUnit(1);

		else if (KEYMANAGER->isKeyDown('2'))
			RemUnit_Toggle ? SaveRemUnit(2) : LoadRemUnit(2);

		else if (KEYMANAGER->isKeyDown('3'))
			RemUnit_Toggle ? SaveRemUnit(3) : LoadRemUnit(3);

		else if (KEYMANAGER->isKeyDown('4'))
			RemUnit_Toggle ? SaveRemUnit(4) : LoadRemUnit(4);

		else if (KEYMANAGER->isKeyDown('5'))
			RemUnit_Toggle ? SaveRemUnit(5) : LoadRemUnit(5);

		else if (KEYMANAGER->isKeyDown('6'))
			RemUnit_Toggle ? SaveRemUnit(6) : LoadRemUnit(6);

		else if (KEYMANAGER->isKeyDown('7'))
			RemUnit_Toggle ? SaveRemUnit(7) : LoadRemUnit(7);

		else if (KEYMANAGER->isKeyDown('8'))
			RemUnit_Toggle ? SaveRemUnit(8) : LoadRemUnit(8);

		else if (KEYMANAGER->isKeyDown('9'))
			RemUnit_Toggle ? SaveRemUnit(9) : LoadRemUnit(9);

		else if (KEYMANAGER->isKeyDown('0'))
			RemUnit_Toggle ? SaveRemUnit(0) : LoadRemUnit(0);
	}


	if (KEYMANAGER->isKeyUp(VK_LCONTROL))
		RemUnit_Toggle = false;

	//포커싱
	if (KEYMANAGER->isKeyUp(VK_TAB))
	{
		if (vMultiSelect.size() < 1)
		{
			if (cFocusTacDollID != 0)
				this->getIOPdoll_crntSquad(cFocusTacDollID)->revFocus();

			if (focusTacdolID != 0)
				this->getIOPdoll_crntSquad(focusTacdolID)->revSelect();

			focusTacdolID = 0;
			cFocusTacDollID = 0;
		}

		else
		{
			for (auto& it : vMultiSelect)
				this->getIOPdoll_crntSquad(it)->revSelect();
			vMultiSelect.clear();
		}
	}


	//좌클릭시
	if (KEYMANAGER->isKeyDown(VK_LBUTTON))
	{
		////화력지원소대 포커싱일경우
		//if (getIOPsptDoll_crntFocus() != nullptr)
		//{
		//	//화력지원부대가 호출되어있지는 않는다면
		//	if (!getIOPsptDoll_crntFocus()->isCalling())
		//	{
		//		//시작지점을 정한다.
				if (vMultiSelect.size() > 0)
				{
					for (auto& it : vMultiSelect)
						this->getIOPdoll_crntSquad(it)->revSelect();
					vMultiSelect.clear();
				}

				else
				{
					if (cFocusTacDollID != 0)
						this->getIOPdoll_crntSquad(cFocusTacDollID)->revFocus();

					if (focusTacdolID != 0)
						this->getIOPdoll_crntSquad(focusTacdolID)->revSelect();

					focusTacdolID = 0;
					cFocusTacDollID = 0;
				}

				sPos.x = _ptMouse.x + BDATA->getVirtualPos().x;
				sPos.y = _ptMouse.y + BDATA->getVirtualPos().y;

				multiSelectMod = true;
		//	}

		//	//폭탄 투하위치 지정
		//	else
		//		getIOPsptDoll_crntFocus()->setTargetPosition();
		//}

		//else
		{
			//if (getIOPdoll_crntSquadFocus() != nullptr)
			//	getIOPdoll_crntSquadFocus()->SetMovePoint();

		}
	}


	//다중 대상 지정중
	if (KEYMANAGER->isKeyStayDown(VK_LBUTTON))
	{
		ePos.x = _ptMouse.x + VPOS->x;
		ePos.y = _ptMouse.y + VPOS->y;
	}


	//다중 대상 지정 완료
	if (KEYMANAGER->isKeyUp(VK_LBUTTON))
	{
		if (multiSelectMod)
		{
			ePos.x = _ptMouse.x + VPOS->x;
			ePos.y = _ptMouse.y + VPOS->y;

			if (sPos.x > ePos.x)
			{
				int temp = sPos.x;
				sPos.x = ePos.x;
				ePos.x = temp;
			}

			if (sPos.y > ePos.y)
			{
				int temp = sPos.y;
				sPos.y = ePos.y;
				ePos.y = temp;
			}

			RECT rc = RectMake(sPos.x, sPos.y, ePos.x - sPos.x, ePos.y - sPos.y);

			for (auto& it : tacDoll->getSquad(currentSquad)->mSquad)
			{
				if (!it.second->getAlive())continue;

				POINT cp;
				cp.x = it.second->getCharacterPos().x;
				cp.y = it.second->getCharacterPos().y;

				if (PtInRect(&rc, cp))
				{
					vMultiSelect.push_back(it.first);
					it.second->revSelect();
				}
			}

			//단일 인형만을 선택했을경우
			if (vMultiSelect.size() == 1)
			{
				getIOPdoll_crntSquad(*vMultiSelect.begin())->revSelect();
				Change_FocusTacDoll_Func(*vMultiSelect.begin());
				vMultiSelect.clear();
			}

			mPos.x = mPos.y = 0.0f;

			multiSelectMod = false;
		}
	}


	//이동, 공격대상 변경
	if (KEYMANAGER->isKeyUp(VK_RBUTTON))
	{
		if (!Targetting_Other())
		{
			if (vMultiSelect.size() < 1)
			{
				//포커싱된 인형이 존재한다면
				if (getIOPdoll_crntSquadFocus() != nullptr)
					getIOPdoll_crntSquadFocus()->SetMovePoint();
			}

			//다중 선택일 경우에
			else
			{
				for (auto& it : vMultiSelect)
				{
					auto& me = (*getIOPdoll_crntSquad(it));

					trgPos.x = _ptMouse.x - (mPos.x - me.getCharacterPos().x) + VPOS->x;
					trgPos.y = _ptMouse.y - (mPos.y - me.getCharacterPos().y) + VPOS->y;

					me.MovePoint(trgPos.x, trgPos.y);
				}
			}
		}
	}


	//정지
	if (KEYMANAGER->isKeyUp('S'))
	{
		if (vMultiSelect.size() < 1) {
			if (this->getIOPdoll_crntSquadFocus() != nullptr)
				if (this->getIOPdoll_crntSquadFocus()->getAlive())
					this->getIOPdoll_crntSquadFocus()->StopMoving();
		}

		else
		{
			for (auto& it : vMultiSelect)
			{
				auto& me = (*getIOPdoll_crntSquad(it));
				me.StopMoving();
			}
		}
	}


	//스킬 사용
	if (KEYMANAGER->isKeyUp('E'))
	{
		if (vMultiSelect.size() < 1)
			if (this->getIOPdoll_crntSquadFocus() != nullptr)
				if (this->getIOPdoll_crntSquadFocus()->getAlive())
					this->getIOPdoll_crntSquadFocus()->Use_ActiveSkill();
	}
}

void Player::Change_FocusTacDoll_Func(int memID)
{
	if (this->getIOPdoll_crntSquad(memID) != nullptr)
	{
		//1회 누를시 선택, 2번누를시 포커스
		if (focusTacdolID != memID)
		{
			if (cFocusTacDollID != 0)
				this->getIOPdoll_crntSquad(cFocusTacDollID)->revFocus();

			if (focusTacdolID != 0)
				this->getIOPdoll_crntSquad(focusTacdolID)->revSelect();

			cFocusTacDollID = 0;
			focusTacdolID = memID;

			//Select FocusTacDoll
			this->getIOPdoll_crntSquad(focusTacdolID)->revSelect();
		}

		else
		{
			if (cFocusTacDollID == memID)
			{
				this->getIOPdoll_crntSquad(cFocusTacDollID)->revFocus();
				cFocusTacDollID = 0;
			}

			else
			{
				cFocusTacDollID = memID;
				this->getIOPdoll_crntSquad(cFocusTacDollID)->revFocus();
			}

		}
	}
}

void Player::SaveRemUnit(int padID)
{
	//단일선택인경우
	if (vMultiSelect.size() < 1)
	{
		//선택이 되어있을경우
		//if (this->getIOPsptDoll_crntFocus() != nullptr)
		{
			vector<UINT> temp;
			temp.push_back(getIOPdoll_crntSquadFocus()->getID()->SquadMem_ID);

			if (!mRemUnit.count(padID))
				mRemUnit.insert(make_pair(padID, temp));

			else
				mRemUnit.find(padID)->second.swap(temp);
		}
	}

	//다중선택일경우
	else
	{
		vector<UINT> temp;
		temp = vMultiSelect;

		if (!mRemUnit.count(padID))
			mRemUnit.insert(make_pair(padID, temp));

		else
			mRemUnit.find(padID)->second.swap(temp);
	}
}

void Player::LoadRemUnit(int padID)
{
	//해당 부분이 존재하고있을 경우
	if (mRemUnit.count(padID))
	{
		auto& it = *(mRemUnit.find(padID));

		//단일 유닛인 경우 -> 해당유닛으로 포커싱 변동
		if (it.second.size() == 1)
		{
			if (vMultiSelect.size() > 0)
			{
				for (auto& it : vMultiSelect)
					this->getIOPdoll_crntSquad(it)->revSelect();
				vMultiSelect.clear();
			}

			Change_FocusTacDoll_Func(*(it.second.begin()));
		}

		//다중 유닛인경우
		else if (it.second.size() > 1)
		{
			if (vMultiSelect.size() < 1)
			{
				if (cFocusTacDollID != 0)
					this->getIOPdoll_crntSquad(cFocusTacDollID)->revFocus();

				if (focusTacdolID != 0)
					this->getIOPdoll_crntSquad(focusTacdolID)->revSelect();

				focusTacdolID = 0;
				cFocusTacDollID = 0;
			}

			else
			{
				for (auto& it : vMultiSelect)
					this->getIOPdoll_crntSquad(it)->revSelect();
				vMultiSelect.clear();
			}

			vMultiSelect = it.second;

			for (auto& it2 : vMultiSelect)
				getIOPdoll_crntSquad(it2)->revSelect();

		}

	}
}

void Player::AutoSetting_CameraFocus()
{

}

bool Player::Targetting_Other()
{
	if (getIOPdoll_crntSquadFocus() != nullptr)
	{
		for (auto& it : BDATA->getEnemySquad(BDATA->getEngageSquadID())->mSquad)
		{
			//조건
			if (!PtInRect(&(it.second->getCharacterRect()), _ptMouse))continue;
			getIOPdoll_crntSquadFocus()->Set_Targetting_Other(it.first);

			return true;
		}

		return false;
	}
}

void Player::testFuc()
{
	tacDoll->Create_IOPtacDoll(IOP_FNFAL);
	tacDoll->Create_IOPtacDoll(IOP_ARCHITECT);
}

void Player::testinst()
{
	tacDoll->getAllTacDoll().at(0)->init();
	tacDoll->InsertSquad_IOPtacDoll(1, 0);

	tacDoll->getAllTacDoll().at(1)->init();
	tacDoll->InsertSquad_IOPtacDoll(1, 1);
}
